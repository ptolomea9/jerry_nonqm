{% extends "base.html" %}
{% block title %}Outreach Session - Jerry Non-QM{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Progress header -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-3">
            <h1 class="text-xl font-extrabold tracking-tight text-gray-900">Outreach: {{ platform|title }}</h1>
            <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 text-xs font-bold text-indigo-700 ring-1 ring-indigo-200">
                <span id="progress-current">{{ current }}</span>&nbsp;of&nbsp;<span id="progress-total">{{ total }}</span>
            </span>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-2.5 ring-1 ring-gray-200">
            <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-indigo-600 h-2.5 rounded-full transition-all duration-300"
                 style="width: {{ (current / total * 100)|int }}%"></div>
        </div>
    </div>

    <!-- Lead card -->
    <div id="lead-card" class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-100 mb-6">
        <div class="flex items-start justify-between">
            <div>
                <h2 id="lead-name" class="text-xl font-extrabold text-gray-900">{{ lead.name }}</h2>
                <p id="lead-company" class="text-sm font-medium text-gray-500 mt-0.5">{{ lead.company }}</p>
                <div class="flex flex-wrap gap-2 mt-2">
                    <span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-0.5 text-xs font-semibold text-gray-600 ring-1 ring-gray-200">
                        <span id="lead-city">{{ lead.city }}</span>, TX
                    </span>
                    <span class="inline-flex items-center rounded-md bg-amber-50 px-2 py-0.5 text-xs font-semibold text-amber-700 ring-1 ring-amber-200">
                        Rank #<span id="lead-rank">{{ lead.rank }}</span>
                    </span>
                    <span class="inline-flex items-center rounded-md bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700 ring-1 ring-emerald-200">
                        <span id="lead-volume">{{ lead.volume }}</span>
                    </span>
                </div>
            </div>
            {% set platform_badge = {
                'facebook': 'bg-blue-50 text-blue-700 ring-blue-200',
                'linkedin': 'bg-sky-50 text-sky-700 ring-sky-200',
                'instagram': 'bg-pink-50 text-pink-700 ring-pink-200',
                'twitter_x': 'bg-gray-100 text-gray-700 ring-gray-200',
                'youtube': 'bg-red-50 text-red-700 ring-red-200',
                'tiktok': 'bg-violet-50 text-violet-700 ring-violet-200',
                'email': 'bg-emerald-50 text-emerald-700 ring-emerald-200'
            } %}
            <span class="inline-flex items-center rounded-lg {{ platform_badge.get(platform, 'bg-indigo-50 text-indigo-700 ring-indigo-200') }} px-3 py-1.5 text-xs font-bold ring-1">
                {{ platform|title }}
            </span>
        </div>

        <!-- Flyer preview -->
        {% if flyer %}
        <div class="mt-5 rounded-lg bg-gray-50/50 p-4 ring-1 ring-gray-100">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="rounded-md bg-amber-100 p-1.5">
                        <svg class="h-3 w-3 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    </div>
                    <p class="text-xs font-semibold text-gray-500">{{ flyer.name }}</p>
                </div>
                {% if flyer.file_type in ('png', 'jpg', 'jpeg', 'gif') %}
                <button id="btn-copy-flyer" onclick="copyFlyer()"
                        class="inline-flex items-center gap-1.5 rounded-lg bg-amber-500 px-3 py-1.5 text-xs font-semibold text-white hover:bg-amber-400 transition-colors">
                    <span id="copy-flyer-label">Copy Flyer</span>
                    <kbd class="rounded bg-amber-400/50 px-1 py-0.5 text-xs font-bold">C</kbd>
                </button>
                {% endif %}
            </div>
            {% if flyer.file_type in ('png', 'jpg', 'jpeg', 'gif') %}
            <img id="flyer-img" src="{{ url_for('flyers.preview', flyer_id=flyer.id) }}"
                 crossorigin="anonymous"
                 class="max-h-48 object-contain rounded-lg" alt="{{ flyer.name }}">
            {% else %}
            <a href="{{ url_for('flyers.preview', flyer_id=flyer.id) }}" target="_blank"
               class="text-sm font-semibold text-indigo-600 hover:text-indigo-500 transition-colors">Open PDF</a>
            {% endif %}
        </div>
        {% endif %}

        <!-- Message template preview -->
        {% if template %}
        <div class="mt-4 rounded-lg bg-indigo-50/50 p-4 ring-1 ring-indigo-100">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="rounded-md bg-indigo-100 p-1.5">
                        <svg class="h-3 w-3 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                    </div>
                    <p class="text-xs font-semibold text-gray-500">{{ template.name }}</p>
                </div>
                <button id="btn-copy-message" onclick="copyMessage()"
                        class="inline-flex items-center gap-1.5 rounded-lg bg-indigo-500 px-3 py-1.5 text-xs font-semibold text-white hover:bg-indigo-400 transition-colors">
                    <span id="copy-message-label">Copy Message</span>
                    <kbd class="rounded bg-indigo-400/50 px-1 py-0.5 text-xs font-bold">M</kbd>
                </button>
            </div>
            <div id="message-text" class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">{{ rendered_message }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Action buttons -->
    <div class="flex flex-col gap-3">
        <a id="btn-open" href="{{ profile_url }}" target="_blank"
           class="flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-6 py-3.5 text-sm font-bold text-white shadow-lg shadow-indigo-200 hover:bg-indigo-500 transition-all duration-200">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            <span>Open Profile</span>
            <kbd class="rounded bg-indigo-500/50 px-1.5 py-0.5 text-xs font-bold">O</kbd>
        </a>
        <div class="grid grid-cols-3 gap-3">
            <button id="btn-back" onclick="goBack()" {% if current <= 1 %}disabled{% endif %}
                    class="flex items-center justify-center gap-2 rounded-xl bg-amber-500 px-6 py-3 text-sm font-bold text-white hover:bg-amber-400 disabled:opacity-40 disabled:cursor-not-allowed transition-all duration-200">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                <span>Back</span>
                <kbd class="rounded bg-amber-400/50 px-1 py-0.5 text-xs font-bold">B</kbd>
            </button>
            <button id="btn-sent" onclick="logAction('sent')"
                    class="flex items-center justify-center gap-2 rounded-xl bg-emerald-600 px-6 py-3 text-sm font-bold text-white hover:bg-emerald-500 transition-all duration-200">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                <span>Sent</span>
                <kbd class="rounded bg-emerald-500/50 px-1 py-0.5 text-xs font-bold">S</kbd>
            </button>
            <button id="btn-skip" onclick="logAction('skipped')"
                    class="flex items-center justify-center gap-2 rounded-xl bg-gray-500 px-6 py-3 text-sm font-bold text-white hover:bg-gray-400 transition-all duration-200">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
                <span>Skip</span>
                <kbd class="rounded bg-gray-400/50 px-1 py-0.5 text-xs font-bold">X</kbd>
            </button>
        </div>
    </div>

    <!-- Keyboard shortcuts hint -->
    <div class="mt-5 rounded-lg bg-gray-50/50 p-3 ring-1 ring-gray-100">
        <p class="text-center text-xs text-gray-400">
            Keyboard:
            <kbd class="mx-0.5 rounded-md bg-white px-1.5 py-0.5 text-xs font-semibold text-gray-500 ring-1 ring-gray-200">O</kbd> Open
            {% if template %}<kbd class="mx-0.5 rounded-md bg-white px-1.5 py-0.5 text-xs font-semibold text-gray-500 ring-1 ring-gray-200">M</kbd> Copy Message{% endif %}
            <kbd class="mx-0.5 rounded-md bg-white px-1.5 py-0.5 text-xs font-semibold text-gray-500 ring-1 ring-gray-200">C</kbd> Copy Flyer
            <kbd class="mx-0.5 rounded-md bg-white px-1.5 py-0.5 text-xs font-semibold text-gray-500 ring-1 ring-gray-200">B</kbd> Back
            <kbd class="mx-0.5 rounded-md bg-white px-1.5 py-0.5 text-xs font-semibold text-gray-500 ring-1 ring-gray-200">S</kbd> Sent
            <kbd class="mx-0.5 rounded-md bg-white px-1.5 py-0.5 text-xs font-semibold text-gray-500 ring-1 ring-gray-200">X</kbd> Skip
        </p>
    </div>
</div>

<!-- Hidden data for JS -->
<input type="hidden" id="session-id" value="{{ sess.id }}">
<input type="hidden" id="lead-id" value="{{ lead.id }}">
<input type="hidden" id="summary-url" value="{{ url_for('outreach.summary', session_id=sess.id) }}">
{% if template_content %}
<input type="hidden" id="template-content" value="{{ template_content }}">
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/outreach.js') }}"></script>
{% endblock %}
