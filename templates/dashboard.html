{% extends "base.html" %}
{% block title %}Dashboard - Jerry Non-QM{% endblock %}

{% block content %}
<!-- Hero header -->
<div class="relative mb-8 overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-600 via-indigo-700 to-slate-900 px-8 py-8">
    <div class="absolute inset-0 opacity-10">
        <div class="absolute -right-20 -top-20 h-64 w-64 rounded-full bg-white/20 blur-3xl"></div>
        <div class="absolute -left-10 bottom-0 h-48 w-48 rounded-full bg-indigo-300/30 blur-2xl"></div>
    </div>
    <div class="relative flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-extrabold tracking-tight text-white">Dashboard</h1>
            <p class="mt-1 text-indigo-200 text-sm">Texas Non-QM Broker Outreach Command Center</p>
        </div>
        <a href="{{ url_for('dashboard.export_csv') }}"
           class="inline-flex items-center gap-2 rounded-lg bg-white/10 backdrop-blur-sm border border-white/20 px-5 py-2.5 text-sm font-semibold text-white hover:bg-white/20 transition-all duration-200">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Export CSV
        </a>
    </div>
</div>

<!-- KPI Cards -->
<div class="grid grid-cols-2 gap-5 lg:grid-cols-4 mb-8">
    <div class="group relative overflow-hidden rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-100 hover:shadow-md transition-shadow duration-200">
        <div class="flex items-start justify-between">
            <div>
                <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">Total Leads</p>
                <p class="mt-2 text-4xl font-extrabold text-gray-900">{{ total_leads }}</p>
            </div>
            <div class="rounded-lg bg-slate-100 p-2.5">
                <svg class="h-5 w-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 h-1 w-full bg-gradient-to-r from-slate-400 to-slate-200"></div>
    </div>

    <div class="group relative overflow-hidden rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-100 hover:shadow-md transition-shadow duration-200">
        <div class="flex items-start justify-between">
            <div>
                <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">With Website</p>
                <p class="mt-2 text-4xl font-extrabold text-indigo-600">{{ leads_with_website }}</p>
            </div>
            <div class="rounded-lg bg-indigo-50 p-2.5">
                <svg class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
            </div>
        </div>
        {% if total_leads > 0 %}
        <div class="mt-3 flex items-center gap-2">
            <div class="h-1.5 flex-1 rounded-full bg-gray-100">
                <div class="h-1.5 rounded-full bg-indigo-500" style="width: {{ (leads_with_website / total_leads * 100)|round|int }}%"></div>
            </div>
            <span class="text-xs font-medium text-gray-400">{{ (leads_with_website / total_leads * 100)|round|int }}%</span>
        </div>
        {% endif %}
        <div class="absolute bottom-0 left-0 h-1 w-full bg-gradient-to-r from-indigo-500 to-indigo-200"></div>
    </div>

    <div class="group relative overflow-hidden rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-100 hover:shadow-md transition-shadow duration-200">
        <div class="flex items-start justify-between">
            <div>
                <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">With Email</p>
                <p class="mt-2 text-4xl font-extrabold text-emerald-600">{{ leads_with_email }}</p>
            </div>
            <div class="rounded-lg bg-emerald-50 p-2.5">
                <svg class="h-5 w-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
        </div>
        {% if total_leads > 0 %}
        <div class="mt-3 flex items-center gap-2">
            <div class="h-1.5 flex-1 rounded-full bg-gray-100">
                <div class="h-1.5 rounded-full bg-emerald-500" style="width: {{ (leads_with_email / total_leads * 100)|round|int }}%"></div>
            </div>
            <span class="text-xs font-medium text-gray-400">{{ (leads_with_email / total_leads * 100)|round|int }}%</span>
        </div>
        {% endif %}
        <div class="absolute bottom-0 left-0 h-1 w-full bg-gradient-to-r from-emerald-500 to-emerald-200"></div>
    </div>

    <div class="group relative overflow-hidden rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-100 hover:shadow-md transition-shadow duration-200">
        <div class="flex items-start justify-between">
            <div>
                <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">Sessions</p>
                <p class="mt-2 text-4xl font-extrabold text-gray-900">{{ total_sessions }}</p>
            </div>
            <div class="rounded-lg bg-amber-50 p-2.5">
                <svg class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 h-1 w-full bg-gradient-to-r from-amber-400 to-amber-200"></div>
    </div>
</div>

<!-- Social Platform Coverage -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-900">Social Coverage</h2>
        <span class="text-xs text-gray-400 font-medium">out of {{ total_leads }} leads</span>
    </div>
    <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-6">
        {% set platform_config = {
            'facebook':  {'label': 'Facebook',  'icon': 'M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z', 'bg': 'from-blue-500 to-blue-600', 'light': 'bg-blue-50 text-blue-700 ring-blue-100'},
            'linkedin':  {'label': 'LinkedIn',  'icon': 'M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6zM2 9h4v12H2z', 'bg': 'from-sky-500 to-sky-600', 'light': 'bg-sky-50 text-sky-700 ring-sky-100'},
            'instagram': {'label': 'Instagram', 'icon': 'M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 01-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 017.8 2m-.2 2A3.6 3.6 0 004 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 003.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 110 2.5 1.25 1.25 0 010-2.5M12 7a5 5 0 110 10 5 5 0 010-10m0 2a3 3 0 100 6 3 3 0 000-6z', 'bg': 'from-pink-500 to-rose-500', 'light': 'bg-pink-50 text-pink-700 ring-pink-100'},
            'twitter_x': {'label': 'Twitter/X', 'icon': 'M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z', 'bg': 'from-gray-600 to-gray-700', 'light': 'bg-gray-50 text-gray-700 ring-gray-200'},
            'youtube':   {'label': 'YouTube',   'icon': 'M22.54 6.42a2.78 2.78 0 00-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 00-1.94 2A29 29 0 001 12a29 29 0 00.46 5.58A2.78 2.78 0 003.4 19.6C5.12 20 12 20 12 20s6.88 0 8.6-.46a2.78 2.78 0 001.94-2A29 29 0 0023 12a29 29 0 00-.46-5.58zM9.75 15.02V8.98L15.5 12l-5.75 3.02z', 'bg': 'from-red-500 to-red-600', 'light': 'bg-red-50 text-red-700 ring-red-100'},
            'tiktok':    {'label': 'TikTok',    'icon': 'M9 12a4 4 0 104 4V4a5 5 0 005 5', 'bg': 'from-violet-500 to-purple-600', 'light': 'bg-violet-50 text-violet-700 ring-violet-100'}
        } %}
        {% for key, cfg in platform_config.items() %}
        {% set count = platform_counts.get(key, 0) %}
        {% set pct = (count / total_leads * 100)|round|int if total_leads > 0 else 0 %}
        <div class="relative overflow-hidden rounded-xl bg-white p-4 ring-1 ring-gray-100 hover:shadow-md transition-shadow duration-200">
            <div class="flex items-center gap-2 mb-3">
                <div class="rounded-md bg-gradient-to-br {{ cfg.bg }} p-1.5">
                    <svg class="h-3.5 w-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="{{ cfg.icon }}"/></svg>
                </div>
                <span class="text-xs font-semibold text-gray-500">{{ cfg.label }}</span>
            </div>
            <p class="text-2xl font-extrabold text-gray-900">{{ count }}</p>
            <div class="mt-2 flex items-center gap-2">
                <div class="h-1 flex-1 rounded-full bg-gray-100">
                    <div class="h-1 rounded-full bg-gradient-to-r {{ cfg.bg }}" style="width: {{ pct }}%"></div>
                </div>
                <span class="text-xs font-medium text-gray-400">{{ pct }}%</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Outreach + Lists row -->
<div class="grid grid-cols-1 gap-6 lg:grid-cols-5 mb-8">
    <!-- Outreach Summary - wider -->
    <div class="lg:col-span-2 rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-100">
        <div class="flex items-center gap-2 mb-5">
            <div class="rounded-lg bg-indigo-100 p-2">
                <svg class="h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
            <h2 class="text-base font-bold text-gray-900">Outreach Summary</h2>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-5">
            <div class="rounded-lg bg-emerald-50 p-4 text-center ring-1 ring-emerald-100">
                <p class="text-3xl font-extrabold text-emerald-600">{{ total_sent }}</p>
                <p class="mt-1 text-xs font-semibold uppercase tracking-wider text-emerald-500">Sent</p>
            </div>
            <div class="rounded-lg bg-gray-50 p-4 text-center ring-1 ring-gray-100">
                <p class="text-3xl font-extrabold text-gray-500">{{ total_skipped }}</p>
                <p class="mt-1 text-xs font-semibold uppercase tracking-wider text-gray-400">Skipped</p>
            </div>
        </div>

        {% if total_sent + total_skipped > 0 %}
        <div>
            <div class="flex items-center justify-between mb-1.5">
                <span class="text-xs font-medium text-gray-400">Send rate</span>
                <span class="text-xs font-bold text-emerald-600">{{ (total_sent / (total_sent + total_skipped) * 100)|round|int }}%</span>
            </div>
            <div class="h-2 w-full rounded-full bg-gray-100">
                <div class="h-2 rounded-full bg-gradient-to-r from-emerald-400 to-emerald-500" style="width: {{ (total_sent / (total_sent + total_skipped) * 100)|round|int }}%"></div>
            </div>
        </div>
        {% endif %}

        <a href="{{ url_for('outreach.setup') }}" class="mt-5 flex items-center justify-center gap-2 rounded-lg bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-500 transition-colors duration-150 w-full">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            Start Outreach
        </a>
    </div>

    <!-- Lists - wider -->
    <div class="lg:col-span-3 rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-100">
        <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-2">
                <div class="rounded-lg bg-violet-100 p-2">
                    <svg class="h-4 w-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                </div>
                <h2 class="text-base font-bold text-gray-900">Lists</h2>
            </div>
            <a href="{{ url_for('lists.index') }}" class="text-xs font-semibold text-indigo-600 hover:text-indigo-500 transition-colors">View all &rarr;</a>
        </div>
        {% if lists %}
        <div class="space-y-2">
            {% for lst in lists[:5] %}
            <a href="{{ url_for('lists.detail', list_id=lst.id) }}" class="flex items-center justify-between rounded-lg px-4 py-3 hover:bg-gray-50 transition-colors duration-150 group">
                <div class="flex items-center gap-3">
                    <div class="flex h-8 w-8 items-center justify-center rounded-md bg-gray-100 text-xs font-bold text-gray-500 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">
                        {{ lst.row_count }}
                    </div>
                    <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900">{{ lst.name }}</span>
                </div>
                <div class="flex items-center gap-2">
                    {% if lst.enrichment_status == 'complete' %}
                    <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-700 ring-1 ring-emerald-200">
                        <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                        Enriched
                    </span>
                    {% elif lst.enrichment_status == 'none' %}
                    <span class="inline-flex items-center rounded-full bg-gray-50 px-2.5 py-1 text-xs font-semibold text-gray-500 ring-1 ring-gray-200">Not Enriched</span>
                    {% elif lst.enrichment_status == 'error' %}
                    <span class="inline-flex items-center gap-1 rounded-full bg-red-50 px-2.5 py-1 text-xs font-semibold text-red-600 ring-1 ring-red-200">
                        <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Error
                    </span>
                    {% else %}
                    <span class="inline-flex items-center gap-1.5 rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-700 ring-1 ring-amber-200">
                        <svg class="h-3 w-3 animate-spin" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
                        Enriching
                    </span>
                    {% endif %}
                    <svg class="h-4 w-4 text-gray-300 group-hover:text-indigo-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="flex flex-col items-center py-8 text-center">
            <div class="rounded-full bg-gray-100 p-3 mb-3">
                <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <p class="text-sm text-gray-500">No lists yet.</p>
            <a href="{{ url_for('lists.index') }}" class="mt-1 text-sm font-semibold text-indigo-600 hover:text-indigo-500">Upload a CSV &rarr;</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Activity -->
<div class="rounded-xl bg-white shadow-sm ring-1 ring-gray-100">
    <div class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
        <div class="flex items-center gap-2">
            <div class="rounded-lg bg-sky-100 p-2">
                <svg class="h-4 w-4 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <h2 class="text-base font-bold text-gray-900">Recent Activity</h2>
        </div>
        {% if recent_logs %}
        <span class="text-xs font-medium text-gray-400">Last {{ recent_logs|length }} actions</span>
        {% endif %}
    </div>
    {% if recent_logs %}
    <div class="overflow-x-auto">
        <table class="min-w-full">
            <thead>
                <tr class="bg-gray-50/50">
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Lead</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Company</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Platform</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Result</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Time</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
                {% for log in recent_logs %}
                <tr class="hover:bg-gray-50/50 transition-colors duration-100">
                    <td class="px-6 py-3.5 text-sm font-medium text-gray-900">{{ log.lead_name }}</td>
                    <td class="px-6 py-3.5 text-sm text-gray-500">{{ log.company }}</td>
                    <td class="px-6 py-3.5">
                        <span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-gray-200">{{ log.platform }}</span>
                    </td>
                    <td class="px-6 py-3.5">
                        {% if log.result == 'sent' %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-700">
                            <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                            Sent
                        </span>
                        {% else %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-gray-50 px-2.5 py-1 text-xs font-semibold text-gray-500">
                            <span class="h-1.5 w-1.5 rounded-full bg-gray-400"></span>
                            Skipped
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-3.5 text-xs text-gray-400">{{ log.timestamp }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="flex flex-col items-center py-12 text-center">
        <div class="rounded-full bg-gray-100 p-3 mb-3">
            <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <p class="text-sm text-gray-500 mb-1">No outreach activity yet.</p>
        <a href="{{ url_for('outreach.setup') }}" class="text-sm font-semibold text-indigo-600 hover:text-indigo-500">Start a session &rarr;</a>
    </div>
    {% endif %}
</div>
{% endblock %}
