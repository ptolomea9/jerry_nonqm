{% extends "base.html" %}
{% block title %}Lead Browser - Jerry Non-QM{% endblock %}

{% block content %}
<!-- Hero header -->
<div class="relative mb-8 overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-600 via-indigo-700 to-slate-900 px-8 py-8">
    <div class="absolute inset-0 opacity-10">
        <div class="absolute -right-20 -top-20 h-64 w-64 rounded-full bg-white/20 blur-3xl"></div>
        <div class="absolute -left-10 bottom-0 h-48 w-48 rounded-full bg-indigo-300/30 blur-2xl"></div>
    </div>
    <div class="relative flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-extrabold tracking-tight text-white">Lead Browser</h1>
            <p class="mt-1 text-indigo-200 text-sm">{{ total }} leads found</p>
        </div>
        <button onclick="document.getElementById('add-lead-form').classList.toggle('hidden')"
                class="inline-flex items-center gap-2 rounded-lg bg-white/10 backdrop-blur-sm border border-white/20 px-5 py-2.5 text-sm font-semibold text-white hover:bg-white/20 transition-all duration-200">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Lead
        </button>
    </div>
</div>

<!-- Add Lead Form (hidden by default) -->
<div id="add-lead-form" class="hidden mb-6 rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-100">
    <div class="flex items-center gap-2 mb-4">
        <div class="rounded-lg bg-emerald-100 p-2">
            <svg class="h-4 w-4 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
        </div>
        <h2 class="text-base font-bold text-gray-900">Add Lead Manually</h2>
    </div>
    <form method="post" action="{{ url_for('leads.add_lead') }}">
        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Name *</label>
                <input type="text" name="name" required
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Company</label>
                <input type="text" name="company"
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">City</label>
                <input type="text" name="city"
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Email</label>
                <input type="email" name="email"
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Facebook URL</label>
                <input type="url" name="facebook" placeholder="https://facebook.com/..."
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">LinkedIn URL</label>
                <input type="url" name="linkedin" placeholder="https://linkedin.com/..."
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Instagram URL</label>
                <input type="url" name="instagram" placeholder="https://instagram.com/..."
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Twitter/X URL</label>
                <input type="url" name="twitter_x" placeholder="https://x.com/..."
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">YouTube URL</label>
                <input type="url" name="youtube" placeholder="https://youtube.com/..."
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">TikTok URL</label>
                <input type="url" name="tiktok" placeholder="https://tiktok.com/..."
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button type="submit" class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 transition-colors">
                Save Lead
            </button>
            <button type="button" onclick="document.getElementById('add-lead-form').classList.add('hidden')"
                    class="rounded-lg bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-200 transition-colors">
                Cancel
            </button>
        </div>
    </form>
</div>

<!-- Archive tabs -->
<div class="mb-4 flex gap-1 rounded-xl bg-white p-1 shadow-sm ring-1 ring-gray-100">
    <a href="?search={{ search }}&platform={{ platform }}&role={{ role }}&city={{ city }}&sort={{ sort }}&list_id={{ list_id }}"
       class="rounded-lg px-4 py-2 text-sm font-semibold transition-colors {% if show_archived == '' %}bg-indigo-600 text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
        Active Leads
    </a>
    <a href="?search={{ search }}&platform={{ platform }}&role={{ role }}&city={{ city }}&sort={{ sort }}&list_id={{ list_id }}&show_archived=only"
       class="rounded-lg px-4 py-2 text-sm font-semibold transition-colors {% if show_archived == 'only' %}bg-indigo-600 text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
        Contacted{% if archived_count %} <span class="ml-1 inline-flex items-center rounded-full {% if show_archived == 'only' %}bg-white/20{% else %}bg-indigo-100 text-indigo-700{% endif %} px-2 py-0.5 text-xs font-bold">{{ archived_count }}</span>{% endif %}
    </a>
    <a href="?search={{ search }}&platform={{ platform }}&role={{ role }}&city={{ city }}&sort={{ sort }}&list_id={{ list_id }}&show_archived=all"
       class="rounded-lg px-4 py-2 text-sm font-semibold transition-colors {% if show_archived == 'all' %}bg-indigo-600 text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
        All
    </a>
</div>

<!-- Filters -->
<form method="get" class="mb-6 rounded-xl bg-white p-5 shadow-sm ring-1 ring-gray-100">
    {% if show_archived %}
    <input type="hidden" name="show_archived" value="{{ show_archived }}">
    {% endif %}
    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-6">
        <div>
            <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Search</label>
            <input type="text" name="search" value="{{ search }}" placeholder="Name or company..."
                   class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div>
            <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">List</label>
            <select name="list_id" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm">
                <option value="">All Lists</option>
                {% for lst in lists %}
                <option value="{{ lst.id }}" {% if list_id == lst.id|string %}selected{% endif %}>{{ lst.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Platform</label>
            <select name="platform" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm">
                <option value="">All</option>
                <option value="email" {% if platform == 'email' %}selected{% endif %}>Email</option>
                <option value="facebook" {% if platform == 'facebook' %}selected{% endif %}>Facebook</option>
                <option value="linkedin" {% if platform == 'linkedin' %}selected{% endif %}>LinkedIn</option>
                <option value="instagram" {% if platform == 'instagram' %}selected{% endif %}>Instagram</option>
                <option value="twitter_x" {% if platform == 'twitter_x' %}selected{% endif %}>Twitter/X</option>
                <option value="youtube" {% if platform == 'youtube' %}selected{% endif %}>YouTube</option>
                <option value="tiktok" {% if platform == 'tiktok' %}selected{% endif %}>TikTok</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Role</label>
            <select name="role" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm">
                <option value="">All</option>
                <option value="LO" {% if role == 'LO' %}selected{% endif %}>Loan Officer</option>
                <option value="BM" {% if role == 'BM' %}selected{% endif %}>Branch Manager</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">City</label>
            <select name="city" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm">
                <option value="">All</option>
                {% for c in cities %}
                <option value="{{ c.city }}" {% if city == c.city %}selected{% endif %}>{{ c.city }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-1">Sort</label>
            <select name="sort" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm">
                <option value="rank" {% if sort == 'rank' %}selected{% endif %}>Rank</option>
                <option value="name" {% if sort == 'name' %}selected{% endif %}>Name</option>
                <option value="volume" {% if sort == 'volume' %}selected{% endif %}>Volume</option>
                <option value="company" {% if sort == 'company' %}selected{% endif %}>Company</option>
            </select>
        </div>
    </div>
    <div class="mt-3 flex gap-2">
        <button type="submit" class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500 transition-colors">
            Filter
        </button>
        <a href="{{ url_for('leads.index') }}" class="rounded-lg bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-200 transition-colors">
            Reset
        </a>
    </div>
</form>

<!-- Lead table -->
<div class="overflow-x-auto rounded-xl bg-white shadow-sm ring-1 ring-gray-100">
    <table class="min-w-full">
        <thead>
            <tr class="bg-gray-50/50">
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">#</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Name</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Company</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">City</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Volume</th>
                <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-400">Channels</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-50">
            {% for lead in leads %}
            <tr class="hover:bg-gray-50/50 transition-colors duration-100">
                <td class="px-4 py-3 text-sm text-gray-400 font-medium">{{ lead.rank or '' }}</td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">
                    {{ lead.name or '' }}
                    {% if lead.lo_role %}
                    <span class="ml-1 inline-flex items-center rounded-md bg-gray-50 px-1.5 py-0.5 text-xs font-medium text-gray-500 ring-1 ring-gray-200">{{ lead.lo_role }}</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">{{ lead.company or '' }}</td>
                <td class="px-4 py-3 text-sm text-gray-500">{{ lead.city or '' }}</td>
                <td class="px-4 py-3 text-sm text-gray-600 font-medium">{{ lead.volume or '' }}</td>
                <td class="px-4 py-3 text-center">
                    <div class="flex items-center justify-center gap-1 flex-wrap">
                        {% set channels = [
                            (lead.email, 'mailto:' ~ lead.email if lead.email else '', '@', 'bg-emerald-50 text-emerald-700 ring-emerald-200', 'Email: ' ~ (lead.email or '')),
                            (lead.facebook, lead.facebook, 'FB', 'bg-blue-50 text-blue-700 ring-blue-200', 'Facebook'),
                            (lead.linkedin, lead.linkedin, 'IN', 'bg-sky-50 text-sky-700 ring-sky-200', 'LinkedIn'),
                            (lead.instagram, lead.instagram, 'IG', 'bg-pink-50 text-pink-700 ring-pink-200', 'Instagram'),
                            (lead.twitter_x, lead.twitter_x, 'X', 'bg-gray-50 text-gray-700 ring-gray-200', 'Twitter/X'),
                            (lead.youtube, lead.youtube, 'YT', 'bg-red-50 text-red-700 ring-red-200', 'YouTube'),
                            (lead.tiktok, lead.tiktok, 'TT', 'bg-violet-50 text-violet-700 ring-violet-200', 'TikTok')
                        ] %}
                        {% for value, url, abbr, classes, title in channels %}
                        {% if value %}
                        <a href="{{ url }}" {% if abbr != '@' %}target="_blank"{% endif %} title="{{ title }}"
                           class="inline-flex items-center rounded-md {{ classes }} px-1.5 py-0.5 text-xs font-semibold ring-1 hover:opacity-80 transition-opacity">{{ abbr }}</a>
                        {% else %}
                        <span class="inline-flex items-center rounded-md bg-gray-50 px-1.5 py-0.5 text-xs font-medium text-gray-300 ring-1 ring-gray-100">{{ abbr }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="mt-5 flex items-center justify-between">
    <p class="text-sm font-medium text-gray-400">Page {{ page }} of {{ total_pages }}</p>
    <div class="flex gap-2">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}&search={{ search }}&platform={{ platform }}&role={{ role }}&city={{ city }}&sort={{ sort }}&list_id={{ list_id }}&show_archived={{ show_archived }}"
           class="inline-flex items-center gap-1 rounded-lg bg-white px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-gray-200 hover:bg-gray-50 transition-colors">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Previous
        </a>
        {% endif %}
        {% if page < total_pages %}
        <a href="?page={{ page + 1 }}&search={{ search }}&platform={{ platform }}&role={{ role }}&city={{ city }}&sort={{ sort }}&list_id={{ list_id }}&show_archived={{ show_archived }}"
           class="inline-flex items-center gap-1 rounded-lg bg-white px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-gray-200 hover:bg-gray-50 transition-colors">
            Next
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
        </a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}
